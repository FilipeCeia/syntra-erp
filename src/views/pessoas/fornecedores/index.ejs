<%
// Título da página
const pageTitle = 'Gestão de Fornecedores - SYNTRA ERP';
%>
<style>
<link rel="stylesheet" href="/css/datatables.min.css">
<style>
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .status-activo { background-color: #d4edda; color: #155724; }
  .status-inactivo { background-color: #f8d7da; color: #721c24; }
  .card-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .filter-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
</style>
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">Gestão de Fornecedores</h1>
      <p class="mb-0 text-muted">Registo e manutenção de dados de fornecedores</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
        <i class="fas fa-upload"></i> Importar
      </button>
      <button class="btn btn-outline-info me-2" onclick="exportarFornecedores()">
        <i class="fas fa-download"></i> Exportar
      </button>
      <a href="/pessoas/fornecedores/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Fornecedor
      </a>
    </div>
  </div>

  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Fornecedores</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalFornecedores">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-truck fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Activos</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="fornecedoresActivos">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Inactivos</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="fornecedoresInactivos">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-pause-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Compras Este Mês</div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="comprasMes">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filter-section">
    <h5 class="mb-3"><i class="fas fa-filter"></i> Filtros de Pesquisa</h5>
    <div class="row">
      <div class="col-md-3">
        <label class="form-label">Pesquisar</label>
        <input type="text" class="form-control" id="searchInput" placeholder="Nome, NUIT, Email...">
      </div>
      <div class="col-md-2">
        <label class="form-label">Estado</label>
        <select class="form-select" id="statusFilter">
          <option value="">Todos</option>
          <option value="activo">Activo</option>
          <option value="inactivo">Inactivo</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Regime Tributário</label>
        <select class="form-select" id="regimeFilter">
          <option value="">Todos</option>
          <option value="geral">Geral</option>
          <option value="simplificado">Simplificado</option>
          <option value="isento">Isento</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Período de Registo</label>
        <div class="input-group">
          <input type="date" class="form-control" id="dataInicio">
          <span class="input-group-text">até</span>
          <input type="date" class="form-control" id="dataFim">
        </div>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-outline-primary me-2" onclick="aplicarFiltros()">
          <i class="fas fa-search"></i> Filtrar
        </button>
        <button class="btn btn-outline-secondary" onclick="limparFiltros()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Tabela de Fornecedores -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Lista de Fornecedores</h6>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-cog"></i> Opções
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="exportarSelecionados()"><i class="fas fa-download"></i> Exportar Selecionados</a></li>
          <li><a class="dropdown-item" href="#" onclick="alterarStatusSelecionados()"><i class="fas fa-edit"></i> Alterar Status</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="excluirSelecionados()"><i class="fas fa-trash"></i> Excluir Selecionados</a></li>
        </ul>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="fornecedoresTable" width="100%" cellspacing="0">
          <thead class="table-light">
            <tr>
              <th width="30">
                <input type="checkbox" id="selectAll" class="form-check-input">
              </th>
              <th>Código</th>
              <th>Nome/Razão Social</th>
              <th>NUIT</th>
              <th>Contacto</th>
              <th>Email</th>
              <th>Regime Tributário</th>
              <th>Estado</th>
              <th>Última Compra</th>
              <th width="120">Acções</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dados serão carregados via AJAX -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Importação -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importar Fornecedores</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Formatos suportados:</strong> Excel (.xlsx), CSV (.csv)
        </div>
        
        <div class="mb-3">
          <label class="form-label">Arquivo para importação</label>
          <input type="file" class="form-control" id="importFile" accept=".xlsx,.csv">
          <div class="form-text">Tamanho máximo: 10MB</div>
        </div>
        
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <span>Precisa do template padrão?</span>
            <button class="btn btn-sm btn-outline-primary" onclick="downloadTemplate()">
              <i class="fas fa-download"></i> Baixar Template
            </button>
          </div>
        </div>
        
        <div id="importProgress" class="d-none">
          <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <div id="importStatus"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="iniciarImportacao()">Importar</button>
      </div>
    </div>
  </div>
</div>

<script>
<script src="/js/datatables.min.js"></script>
<script>
$(document).ready(function() {
  // Inicializar DataTable
  const table = $('#fornecedoresTable').DataTable({
    processing: true,
    serverSide: true,
    ajax: {
      url: '/pessoas/fornecedores/data',
      type: 'POST',
      data: function(d) {
        d.search = $('#searchInput').val();
        d.status = $('#statusFilter').val();
        d.regime = $('#regimeFilter').val();
        d.dataInicio = $('#dataInicio').val();
        d.dataFim = $('#dataFim').val();
      }
    },
    columns: [
      { data: 'checkbox', orderable: false, searchable: false },
      { data: 'codigo' },
      { data: 'nome' },
      { data: 'nuit' },
      { data: 'telefone' },
      { data: 'email' },
      { data: 'regime_tributario' },
      { data: 'status' },
      { data: 'ultima_compra' },
      { data: 'acoes', orderable: false, searchable: false }
    ],
    language: {
      url: '/js/datatables-pt.json'
    },
    order: [[2, 'asc']],
    pageLength: 25,
    responsive: true
  });
  
  // Carregar estatísticas
  carregarEstatisticas();
  
  // Select All checkbox
  $('#selectAll').on('change', function() {
    $('.row-checkbox').prop('checked', this.checked);
  });
});

function aplicarFiltros() {
  $('#fornecedoresTable').DataTable().ajax.reload();
}

function limparFiltros() {
  $('#searchInput').val('');
  $('#statusFilter').val('');
  $('#regimeFilter').val('');
  $('#dataInicio').val('');
  $('#dataFim').val('');
  aplicarFiltros();
}

function carregarEstatisticas() {
  $.get('/pessoas/fornecedores/estatisticas', function(data) {
    $('#totalFornecedores').text(data.total || 0);
    $('#fornecedoresActivos').text(data.activos || 0);
    $('#fornecedoresInactivos').text(data.inactivos || 0);
    $('#comprasMes').text(data.compras_mes || 0);
  });
}

function exportarFornecedores() {
  const filtros = {
    search: $('#searchInput').val(),
    status: $('#statusFilter').val(),
    regime: $('#regimeFilter').val(),
    dataInicio: $('#dataInicio').val(),
    dataFim: $('#dataFim').val()
  };
  
  const params = new URLSearchParams(filtros).toString();
  window.open(`/pessoas/fornecedores/export?${params}`, '_blank');
}

function downloadTemplate() {
  window.open('/pessoas/fornecedores/template', '_blank');
}

function iniciarImportacao() {
  const fileInput = document.getElementById('importFile');
  if (!fileInput.files[0]) {
    alert('Por favor, selecione um arquivo para importar.');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  
  $('#importProgress').removeClass('d-none');
  
  $.ajax({
    url: '/pessoas/fornecedores/import',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    xhr: function() {
      const xhr = new window.XMLHttpRequest();
      xhr.upload.addEventListener('progress', function(evt) {
        if (evt.lengthComputable) {
          const percentComplete = evt.loaded / evt.total * 100;
          $('.progress-bar').css('width', percentComplete + '%');
        }
      }, false);
      return xhr;
    },
    success: function(response) {
      if (response.success) {
        $('#importModal').modal('hide');
        $('#fornecedoresTable').DataTable().ajax.reload();
        carregarEstatisticas();
        alert('Importação concluída com sucesso!');
      } else {
        alert('Erro na importação: ' + response.message);
      }
    },
    error: function() {
      alert('Erro ao processar importação.');
    }
  });
}

function verFornecedor(id) {
  window.location.href = `/pessoas/fornecedores/${id}`;
}

function editarFornecedor(id) {
  window.location.href = `/pessoas/fornecedores/${id}/edit`;
}

function excluirFornecedor(id) {
  if (confirm('Tem certeza que deseja excluir este fornecedor?')) {
    $.ajax({
      url: `/pessoas/fornecedores/${id}`,
      type: 'DELETE',
      success: function(response) {
        if (response.success) {
          $('#fornecedoresTable').DataTable().ajax.reload();
          carregarEstatisticas();
          alert('Fornecedor excluído com sucesso!');
        } else {
          alert('Erro ao excluir fornecedor: ' + response.message);
        }
      },
      error: function() {
        alert('Erro ao excluir fornecedor.');
      }
    });
  }
}

function alterarStatus(id, novoStatus) {
  $.ajax({
    url: `/pessoas/fornecedores/${id}/status`,
    type: 'PUT',
    data: { status: novoStatus },
    success: function(response) {
      if (response.success) {
        $('#fornecedoresTable').DataTable().ajax.reload();
        carregarEstatisticas();
      } else {
        alert('Erro ao alterar status: ' + response.message);
      }
    }
  });
}

function verHistoricoCompras(id) {
  window.location.href = `/pessoas/fornecedores/${id}/historico`;
}
</script>
</script>