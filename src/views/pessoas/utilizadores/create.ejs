<%- contentFor('title') %>
Criar Utilizador - SYNTRA ERP
<% end %>

<%- contentFor('styles') %>
<style>
  .form-section {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .section-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
  }
  .required-field {
    color: #dc3545;
  }
  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  .permission-group {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
  }
  .permission-group h6 {
    color: #495057;
    margin-bottom: 10px;
    font-weight: 600;
  }
  .permission-item {
    margin-bottom: 8px;
  }
  .permission-item .form-check {
    margin-bottom: 0;
  }
  .loja-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.2s;
  }
  .loja-card:hover {
    background-color: #e9ecef;
  }
  .loja-card.selected {
    background-color: #d1ecf1;
    border-color: #bee5eb;
  }
  .perfil-card {
    background-color: #ffffff;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .perfil-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .perfil-card.selected {
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  .perfil-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
    color: #6c757d;
  }
  .perfil-card.selected .perfil-icon {
    color: #007bff;
  }
  .perfil-title {
    font-weight: 600;
    margin-bottom: 5px;
  }
  .perfil-description {
    font-size: 0.875rem;
    color: #6c757d;
  }
  .password-strength {
    margin-top: 5px;
  }
  .strength-bar {
    height: 4px;
    border-radius: 2px;
    transition: all 0.3s;
  }
  .strength-weak {
    background-color: #dc3545;
    width: 25%;
  }
  .strength-fair {
    background-color: #ffc107;
    width: 50%;
  }
  .strength-good {
    background-color: #28a745;
    width: 75%;
  }
  .strength-strong {
    background-color: #007bff;
    width: 100%;
  }
  .avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 2rem;
    margin: 0 auto 20px;
  }
  .btn-action {
    min-width: 120px;
  }
  .form-floating > .form-control {
    height: calc(3.5rem + 2px);
    line-height: 1.25;
  }
  .form-floating > label {
    padding: 1rem 0.75rem;
  }
  .invalid-feedback {
    display: block;
  }
  .is-invalid {
    border-color: #dc3545;
  }
  .is-valid {
    border-color: #28a745;
  }
  .email-suggestion {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 8px 12px;
    margin-top: 5px;
    font-size: 0.875rem;
    cursor: pointer;
  }
  .email-suggestion:hover {
    background-color: #bbdefb;
  }
</style>
<% end %>

<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">Criar Novo Utilizador</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="/pessoas">Pessoas</a></li>
          <li class="breadcrumb-item"><a href="/pessoas/utilizadores">Utilizadores</a></li>
          <li class="breadcrumb-item active">Criar</li>
        </ol>
      </nav>
    </div>
    <div>
      <a href="/pessoas/utilizadores" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left"></i> Voltar
      </a>
      <button type="button" class="btn btn-outline-info me-2" onclick="previewUtilizador()">
        <i class="fas fa-eye"></i> Pré-visualizar
      </button>
    </div>
  </div>

  <form id="formUtilizador" novalidate>
    <div class="row">
      <!-- Coluna Principal -->
      <div class="col-lg-8">
        <!-- Dados Básicos -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-user"></i> Dados Básicos
          </h5>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome completo" required>
                <label for="nome">Nome Completo <span class="required-field">*</span></label>
                <div class="invalid-feedback">Por favor, insira o nome completo.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                <label for="email">Email <span class="required-field">*</span></label>
                <div class="invalid-feedback">Por favor, insira um email válido.</div>
                <div id="emailSuggestion" class="email-suggestion" style="display: none;"></div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="codigo" name="codigo" placeholder="Código do utilizador">
                <label for="codigo">Código do Utilizador</label>
                <div class="form-text">Deixe em branco para gerar automaticamente</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="Telefone">
                <label for="telefone">Telefone</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Credenciais de Acesso -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-key"></i> Credenciais de Acesso
          </h5>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="senha" name="senha" placeholder="Senha" required>
                <label for="senha">Senha <span class="required-field">*</span></label>
                <div class="invalid-feedback">A senha deve ter pelo menos 8 caracteres.</div>
                <div class="password-strength">
                  <div class="strength-bar" id="strengthBar"></div>
                  <small class="text-muted" id="strengthText">Digite uma senha</small>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha" placeholder="Confirmar senha" required>
                <label for="confirmarSenha">Confirmar Senha <span class="required-field">*</span></label>
                <div class="invalid-feedback">As senhas não coincidem.</div>
              </div>
            </div>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="enviarCredenciais" name="enviarCredenciais" checked>
            <label class="form-check-label" for="enviarCredenciais">
              Enviar credenciais por email
            </label>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="alterarSenhaProximoLogin" name="alterarSenhaProximoLogin">
            <label class="form-check-label" for="alterarSenhaProximoLogin">
              Forçar alteração de senha no próximo login
            </label>
          </div>
        </div>

        <!-- Perfil e Permissões -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-shield-alt"></i> Perfil e Permissões
          </h5>
          
          <div class="row">
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="admin">
                <div class="perfil-icon">
                  <i class="fas fa-crown"></i>
                </div>
                <div class="perfil-title">Administrador</div>
                <div class="perfil-description">Acesso total ao sistema</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="gerente">
                <div class="perfil-icon">
                  <i class="fas fa-user-tie"></i>
                </div>
                <div class="perfil-title">Gerente</div>
                <div class="perfil-description">Gestão e relatórios</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="vendedor">
                <div class="perfil-icon">
                  <i class="fas fa-handshake"></i>
                </div>
                <div class="perfil-title">Vendedor</div>
                <div class="perfil-description">Vendas e clientes</div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="caixa">
                <div class="perfil-icon">
                  <i class="fas fa-cash-register"></i>
                </div>
                <div class="perfil-title">Operador de Caixa</div>
                <div class="perfil-description">POS e vendas</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="operador">
                <div class="perfil-icon">
                  <i class="fas fa-user"></i>
                </div>
                <div class="perfil-title">Operador</div>
                <div class="perfil-description">Acesso limitado</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="perfil-card" data-perfil="personalizado">
                <div class="perfil-icon">
                  <i class="fas fa-cog"></i>
                </div>
                <div class="perfil-title">Personalizado</div>
                <div class="perfil-description">Permissões específicas</div>
              </div>
            </div>
          </div>
          
          <input type="hidden" id="perfilSelecionado" name="perfil" required>
          
          <!-- Permissões Específicas (mostrado apenas para perfil personalizado) -->
          <div id="permissoesEspecificas" style="display: none;">
            <h6 class="mt-4 mb-3">Permissões Específicas</h6>
            
            <div class="row">
              <div class="col-md-6">
                <div class="permission-group">
                  <h6><i class="fas fa-shopping-cart"></i> Vendas</h6>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_vendas_criar" name="permissoes[]" value="vendas_criar">
                      <label class="form-check-label" for="perm_vendas_criar">Criar vendas</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_vendas_editar" name="permissoes[]" value="vendas_editar">
                      <label class="form-check-label" for="perm_vendas_editar">Editar vendas</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_vendas_cancelar" name="permissoes[]" value="vendas_cancelar">
                      <label class="form-check-label" for="perm_vendas_cancelar">Cancelar vendas</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_vendas_desconto" name="permissoes[]" value="vendas_desconto">
                      <label class="form-check-label" for="perm_vendas_desconto">Aplicar descontos</label>
                    </div>
                  </div>
                </div>
                
                <div class="permission-group">
                  <h6><i class="fas fa-box"></i> Stock</h6>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_stock_consultar" name="permissoes[]" value="stock_consultar">
                      <label class="form-check-label" for="perm_stock_consultar">Consultar stock</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_stock_ajustar" name="permissoes[]" value="stock_ajustar">
                      <label class="form-check-label" for="perm_stock_ajustar">Ajustar stock</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_stock_transferir" name="permissoes[]" value="stock_transferir">
                      <label class="form-check-label" for="perm_stock_transferir">Transferir stock</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="permission-group">
                  <h6><i class="fas fa-chart-bar"></i> Relatórios</h6>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_relatorios_vendas" name="permissoes[]" value="relatorios_vendas">
                      <label class="form-check-label" for="perm_relatorios_vendas">Relatórios de vendas</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_relatorios_financeiros" name="permissoes[]" value="relatorios_financeiros">
                      <label class="form-check-label" for="perm_relatorios_financeiros">Relatórios financeiros</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_relatorios_stock" name="permissoes[]" value="relatorios_stock">
                      <label class="form-check-label" for="perm_relatorios_stock">Relatórios de stock</label>
                    </div>
                  </div>
                </div>
                
                <div class="permission-group">
                  <h6><i class="fas fa-cogs"></i> Configurações</h6>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_config_sistema" name="permissoes[]" value="config_sistema">
                      <label class="form-check-label" for="perm_config_sistema">Configurações do sistema</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_config_utilizadores" name="permissoes[]" value="config_utilizadores">
                      <label class="form-check-label" for="perm_config_utilizadores">Gestão de utilizadores</label>
                    </div>
                  </div>
                  <div class="permission-item">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="perm_config_backup" name="permissoes[]" value="config_backup">
                      <label class="form-check-label" for="perm_config_backup">Backup e restauro</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lojas Acessíveis -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-store"></i> Lojas Acessíveis
          </h5>
          
          <div class="row">
            <div class="col-md-4">
              <div class="loja-card" data-loja="1">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="loja1" name="lojas[]" value="1">
                  <label class="form-check-label" for="loja1">
                    <strong>Loja Principal</strong><br>
                    <small class="text-muted">Rua Principal, 123</small>
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="loja-card" data-loja="2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="loja2" name="lojas[]" value="2">
                  <label class="form-check-label" for="loja2">
                    <strong>Loja Secundária</strong><br>
                    <small class="text-muted">Avenida Central, 456</small>
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="loja-card" data-loja="3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="loja3" name="lojas[]" value="3">
                  <label class="form-check-label" for="loja3">
                    <strong>Armazém</strong><br>
                    <small class="text-muted">Zona Industrial</small>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="todasLojas" onchange="selecionarTodasLojas()">
            <label class="form-check-label" for="todasLojas">
              Selecionar todas as lojas
            </label>
          </div>
        </div>
      </div>

      <!-- Coluna Lateral -->
      <div class="col-lg-4">
        <!-- Pré-visualização -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-eye"></i> Pré-visualização
          </h5>
          
          <div class="text-center">
            <div class="avatar-preview" id="avatarPreview">?</div>
            <h6 id="previewNome">Nome do Utilizador</h6>
            <p class="text-muted" id="previewEmail">email@exemplo.com</p>
            <span class="badge bg-secondary" id="previewPerfil">Selecione um perfil</span>
          </div>
          
          <hr>
          
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span>Código:</span>
              <span id="previewCodigo">-</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Telefone:</span>
              <span id="previewTelefone">-</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Lojas:</span>
              <span id="previewLojas">0</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Permissões:</span>
              <span id="previewPermissoes">0</span>
            </div>
          </div>
        </div>

        <!-- Configurações Adicionais -->
        <div class="form-section">
          <h5 class="section-title">
            <i class="fas fa-cog"></i> Configurações
          </h5>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
            <label class="form-check-label" for="ativo">
              Utilizador ativo
            </label>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="notificacoes" name="notificacoes" checked>
            <label class="form-check-label" for="notificacoes">
              Receber notificações
            </label>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="relatoriosEmail" name="relatoriosEmail">
            <label class="form-check-label" for="relatoriosEmail">
              Relatórios por email
            </label>
          </div>
          
          <div class="mb-3">
            <label for="observacoes" class="form-label">Observações</label>
            <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Observações sobre o utilizador..."></textarea>
          </div>
        </div>

        <!-- Acções -->
        <div class="form-section">
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-action">
              <i class="fas fa-save"></i> Criar Utilizador
            </button>
            <button type="button" class="btn btn-outline-secondary btn-action" onclick="salvarRascunho()">
              <i class="fas fa-file-alt"></i> Salvar como Rascunho
            </button>
            <button type="button" class="btn btn-outline-warning btn-action" onclick="limparFormulario()">
              <i class="fas fa-eraser"></i> Limpar Formulário
            </button>
            <a href="/pessoas/utilizadores" class="btn btn-outline-danger btn-action">
              <i class="fas fa-times"></i> Cancelar
            </a>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal de Pré-visualização -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-eye"></i> Pré-visualização do Utilizador
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="previewModalContent">
        <!-- Conteúdo será carregado dinamicamente -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" onclick="$('#previewModal').modal('hide'); $('#formUtilizador').submit();">Criar Utilizador</button>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script>
// Inicialização
$(document).ready(function() {
  // Configurar validação do formulário
  configurarValidacao();
  
  // Configurar eventos
  configurarEventos();
  
  // Gerar código automático
  gerarCodigoAutomatico();
  
  // Configurar máscaras
  configurarMascaras();
});

// Configurar validação
function configurarValidacao() {
  const form = document.getElementById('formUtilizador');
  
  form.addEventListener('submit', function(event) {
    event.preventDefault();
    event.stopPropagation();
    
    if (validarFormulario()) {
      salvarUtilizador();
    }
    
    form.classList.add('was-validated');
  });
}

// Configurar eventos
function configurarEventos() {
  // Eventos de perfil
  $('.perfil-card').on('click', function() {
    $('.perfil-card').removeClass('selected');
    $(this).addClass('selected');
    
    const perfil = $(this).data('perfil');
    $('#perfilSelecionado').val(perfil);
    
    // Mostrar/ocultar permissões específicas
    if (perfil === 'personalizado') {
      $('#permissoesEspecificas').show();
    } else {
      $('#permissoesEspecificas').hide();
      // Limpar permissões específicas
      $('input[name="permissoes[]"]').prop('checked', false);
    }
    
    atualizarPreview();
  });
  
  // Eventos de loja
  $('.loja-card').on('click', function() {
    const checkbox = $(this).find('input[type="checkbox"]');
    checkbox.prop('checked', !checkbox.prop('checked'));
    
    if (checkbox.prop('checked')) {
      $(this).addClass('selected');
    } else {
      $(this).removeClass('selected');
    }
    
    atualizarPreview();
  });
  
  // Eventos de campos
  $('#nome, #email, #codigo, #telefone').on('input', atualizarPreview);
  $('input[name="lojas[]"], input[name="permissoes[]"]').on('change', atualizarPreview);
  
  // Validação de senha
  $('#senha').on('input', function() {
    validarForcaSenha($(this).val());
  });
  
  $('#confirmarSenha').on('input', function() {
    validarConfirmacaoSenha();
  });
  
  // Sugestão de email
  $('#nome').on('input', function() {
    sugerirEmail();
  });
}

// Configurar máscaras
function configurarMascaras() {
  // Máscara para telefone
  $('#telefone').mask('(00) 00000-0000', {
    placeholder: '(00) 00000-0000'
  });
}

// Gerar código automático
function gerarCodigoAutomatico() {
  $('#nome').on('input', function() {
    if (!$('#codigo').val()) {
      const nome = $(this).val();
      if (nome.length >= 3) {
        const codigo = 'USR' + nome.substring(0, 3).toUpperCase() + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
        $('#codigo').val(codigo);
        atualizarPreview();
      }
    }
  });
}

// Sugerir email
function sugerirEmail() {
  const nome = $('#nome').val();
  const email = $('#email').val();
  
  if (nome.length >= 3 && !email) {
    const nomePartes = nome.toLowerCase().split(' ');
    let sugestao = '';
    
    if (nomePartes.length >= 2) {
      sugestao = nomePartes[0] + '.' + nomePartes[nomePartes.length - 1] + '@empresa.com';
    } else {
      sugestao = nomePartes[0] + '@empresa.com';
    }
    
    $('#emailSuggestion').html(`Sugestão: <strong>${sugestao}</strong>`).show().on('click', function() {
      $('#email').val(sugestao);
      $(this).hide();
      atualizarPreview();
    });
  } else {
    $('#emailSuggestion').hide();
  }
}

// Validar força da senha
function validarForcaSenha(senha) {
  const strengthBar = $('#strengthBar');
  const strengthText = $('#strengthText');
  
  let score = 0;
  let feedback = '';
  
  if (senha.length >= 8) score++;
  if (/[a-z]/.test(senha)) score++;
  if (/[A-Z]/.test(senha)) score++;
  if (/[0-9]/.test(senha)) score++;
  if (/[^A-Za-z0-9]/.test(senha)) score++;
  
  strengthBar.removeClass('strength-weak strength-fair strength-good strength-strong');
  
  switch (score) {
    case 0:
    case 1:
      strengthBar.addClass('strength-weak');
      feedback = 'Muito fraca';
      break;
    case 2:
      strengthBar.addClass('strength-fair');
      feedback = 'Fraca';
      break;
    case 3:
    case 4:
      strengthBar.addClass('strength-good');
      feedback = 'Boa';
      break;
    case 5:
      strengthBar.addClass('strength-strong');
      feedback = 'Muito forte';
      break;
  }
  
  strengthText.text(feedback);
}

// Validar confirmação de senha
function validarConfirmacaoSenha() {
  const senha = $('#senha').val();
  const confirmarSenha = $('#confirmarSenha').val();
  const field = $('#confirmarSenha')[0];
  
  if (senha !== confirmarSenha) {
    field.setCustomValidity('As senhas não coincidem');
    $('#confirmarSenha').addClass('is-invalid').removeClass('is-valid');
  } else {
    field.setCustomValidity('');
    $('#confirmarSenha').addClass('is-valid').removeClass('is-invalid');
  }
}

// Selecionar todas as lojas
function selecionarTodasLojas() {
  const todasSelecionadas = $('#todasLojas').prop('checked');
  
  $('input[name="lojas[]"]').prop('checked', todasSelecionadas);
  
  if (todasSelecionadas) {
    $('.loja-card').addClass('selected');
  } else {
    $('.loja-card').removeClass('selected');
  }
  
  atualizarPreview();
}

// Atualizar pré-visualização
function atualizarPreview() {
  const nome = $('#nome').val() || 'Nome do Utilizador';
  const email = $('#email').val() || 'email@exemplo.com';
  const codigo = $('#codigo').val() || '-';
  const telefone = $('#telefone').val() || '-';
  const perfil = $('#perfilSelecionado').val();
  
  // Atualizar avatar
  const iniciais = nome.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  $('#avatarPreview').text(iniciais || '?');
  
  // Atualizar informações
  $('#previewNome').text(nome);
  $('#previewEmail').text(email);
  $('#previewCodigo').text(codigo);
  $('#previewTelefone').text(telefone);
  
  // Atualizar perfil
  const perfilNomes = {
    'admin': 'Administrador',
    'gerente': 'Gerente',
    'vendedor': 'Vendedor',
    'caixa': 'Operador de Caixa',
    'operador': 'Operador',
    'personalizado': 'Personalizado'
  };
  
  if (perfil) {
    $('#previewPerfil').text(perfilNomes[perfil]).removeClass('bg-secondary').addClass('bg-primary');
  } else {
    $('#previewPerfil').text('Selecione um perfil').removeClass('bg-primary').addClass('bg-secondary');
  }
  
  // Contar lojas selecionadas
  const lojasCount = $('input[name="lojas[]"]:checked').length;
  $('#previewLojas').text(lojasCount);
  
  // Contar permissões selecionadas
  const permissoesCount = $('input[name="permissoes[]"]:checked').length;
  $('#previewPermissoes').text(permissoesCount);
}

// Validar formulário
function validarFormulario() {
  let valido = true;
  
  // Validar campos obrigatórios
  const camposObrigatorios = ['nome', 'email', 'senha', 'confirmarSenha'];
  
  camposObrigatorios.forEach(campo => {
    const element = $(`#${campo}`);
    if (!element.val().trim()) {
      element.addClass('is-invalid');
      valido = false;
    } else {
      element.removeClass('is-invalid').addClass('is-valid');
    }
  });
  
  // Validar email
  const email = $('#email').val();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    $('#email').addClass('is-invalid');
    valido = false;
  }
  
  // Validar senha
  const senha = $('#senha').val();
  if (senha.length < 8) {
    $('#senha').addClass('is-invalid');
    valido = false;
  }
  
  // Validar confirmação de senha
  validarConfirmacaoSenha();
  if ($('#confirmarSenha').hasClass('is-invalid')) {
    valido = false;
  }
  
  // Validar perfil
  if (!$('#perfilSelecionado').val()) {
    alert('Por favor, selecione um perfil para o utilizador.');
    valido = false;
  }
  
  // Validar pelo menos uma loja
  if ($('input[name="lojas[]"]:checked').length === 0) {
    alert('Por favor, selecione pelo menos uma loja para o utilizador.');
    valido = false;
  }
  
  return valido;
}

// Salvar utilizador
function salvarUtilizador() {
  const formData = new FormData(document.getElementById('formUtilizador'));
  
  // Simular salvamento
  const btn = $('button[type="submit"]');
  const originalText = btn.html();
  btn.html('<i class="fas fa-spinner fa-spin"></i> Criando...').prop('disabled', true);
  
  setTimeout(function() {
    alert('Utilizador criado com sucesso!');
    window.location.href = '/pessoas/utilizadores';
  }, 2000);
}

// Salvar como rascunho
function salvarRascunho() {
  const btn = $(event.target);
  const originalText = btn.html();
  btn.html('<i class="fas fa-spinner fa-spin"></i> Salvando...').prop('disabled', true);
  
  setTimeout(function() {
    alert('Rascunho salvo com sucesso!');
    btn.html(originalText).prop('disabled', false);
  }, 1000);
}

// Limpar formulário
function limparFormulario() {
  if (confirm('Tem certeza que deseja limpar todos os campos?')) {
    document.getElementById('formUtilizador').reset();
    $('.perfil-card').removeClass('selected');
    $('.loja-card').removeClass('selected');
    $('#perfilSelecionado').val('');
    $('#permissoesEspecificas').hide();
    $('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
    $('#strengthBar').removeClass('strength-weak strength-fair strength-good strength-strong');
    $('#strengthText').text('Digite uma senha');
    $('#emailSuggestion').hide();
    atualizarPreview();
  }
}

// Pré-visualizar utilizador
function previewUtilizador() {
  if (!validarFormulario()) {
    alert('Por favor, corrija os erros no formulário antes de pré-visualizar.');
    return;
  }
  
  const nome = $('#nome').val();
  const email = $('#email').val();
  const codigo = $('#codigo').val();
  const telefone = $('#telefone').val();
  const perfil = $('#perfilSelecionado').val();
  const observacoes = $('#observacoes').val();
  
  const lojasSelecionadas = [];
  $('input[name="lojas[]"]:checked').each(function() {
    lojasSelecionadas.push($(this).next('label').find('strong').text());
  });
  
  const permissoesSelecionadas = [];
  $('input[name="permissoes[]"]:checked').each(function() {
    permissoesSelecionadas.push($(this).next('label').text());
  });
  
  const perfilNomes = {
    'admin': 'Administrador',
    'gerente': 'Gerente',
    'vendedor': 'Vendedor',
    'caixa': 'Operador de Caixa',
    'operador': 'Operador',
    'personalizado': 'Personalizado'
  };
  
  const iniciais = nome.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  
  const content = `
    <div class="row">
      <div class="col-md-4 text-center">
        <div class="avatar-preview mb-3">${iniciais}</div>
        <h5>${nome}</h5>
        <p class="text-muted">${email}</p>
        <span class="badge bg-primary">${perfilNomes[perfil]}</span>
      </div>
      <div class="col-md-8">
        <h6>Informações Básicas</h6>
        <table class="table table-sm">
          <tr><td><strong>Código:</strong></td><td>${codigo}</td></tr>
          <tr><td><strong>Telefone:</strong></td><td>${telefone || 'Não informado'}</td></tr>
          <tr><td><strong>Estado:</strong></td><td><span class="badge bg-success">Ativo</span></td></tr>
        </table>
        
        <h6>Lojas Acessíveis</h6>
        <p>${lojasSelecionadas.join(', ') || 'Nenhuma loja selecionada'}</p>
        
        ${permissoesSelecionadas.length > 0 ? `
          <h6>Permissões Específicas</h6>
          <ul class="list-unstyled">
            ${permissoesSelecionadas.map(p => `<li><i class="fas fa-check text-success me-2"></i>${p}</li>`).join('')}
          </ul>
        ` : ''}
        
        ${observacoes ? `
          <h6>Observações</h6>
          <p>${observacoes}</p>
        ` : ''}
      </div>
    </div>
  `;
  
  $('#previewModalContent').html(content);
  $('#previewModal').modal('show');
}
</script>
<% end %>