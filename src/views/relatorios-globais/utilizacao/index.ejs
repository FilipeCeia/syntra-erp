

<style>
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .filter-card {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .user-card {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.2s;
  }
  .user-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: #007bff;
  }
  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
  }
  .status-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 12px;
  }
  .status-activo {
    background-color: #d1edff;
    color: #0c5460;
  }
  .status-inactivo {
    background-color: #f8d7da;
    color: #721c24;
  }
  .status-bloqueado {
    background-color: #fff3cd;
    color: #856404;
  }
  .perfil-badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 10px;
    margin-right: 5px;
  }
  .perfil-admin {
    background-color: #dc3545;
    color: white;
  }
  .perfil-vendedor {
    background-color: #28a745;
    color: white;
  }
  .perfil-caixa {
    background-color: #007bff;
    color: white;
  }
  .perfil-gerente {
    background-color: #fd7e14;
    color: white;
  }
  .perfil-operador {
    background-color: #6c757d;
    color: white;
  }
  .import-modal .modal-body {
    padding: 30px;
  }
  .upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
  }
  .upload-area:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  .upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
  }
  .progress-container {
    margin-top: 20px;
    display: none;
  }
  .last-login {
    font-size: 0.875rem;
    color: #6c757d;
  }
  .permissions-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .permission-item {
    padding: 5px 0;
    border-bottom: 1px solid #f8f9fa;
  }
  .permission-item:last-child {
    border-bottom: none;
  }
  .loja-badge {
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 8px;
    background-color: #e9ecef;
    color: #495057;
    margin-right: 3px;
  }
  .activity-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
  }
  .activity-online {
    background-color: #28a745;
  }
  .activity-offline {
    background-color: #6c757d;
  }
  .activity-away {
    background-color: #ffc107;
  }
</style>


<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">Gestão de Utilizadores</h1>
      <p class="mb-0 text-muted">Controlo de utilizadores e perfis de acesso</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
        <i class="fas fa-upload"></i> Importar
      </button>
      <div class="btn-group me-2">
        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
          <i class="fas fa-download"></i> Exportar
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="exportarPDF()"><i class="fas fa-file-pdf"></i> PDF</a></li>
          <li><a class="dropdown-item" href="#" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Excel</a></li>
          <li><a class="dropdown-item" href="#" onclick="exportarCSV()"><i class="fas fa-file-csv"></i> CSV</a></li>
        </ul>
      </div>
      <a href="/pessoas/utilizadores/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Utilizador
      </a>
    </div>
  </div>

  <!-- Estatísticas -->
  <div class="stats-card">
    <div class="row">
      <div class="col-md-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <i class="fas fa-users fa-2x opacity-75"></i>
          </div>
          <div>
            <div class="h4 mb-0" id="totalUtilizadores"><%= stats.total %></div>
            <div class="small opacity-75">Total de Utilizadores</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <i class="fas fa-user-check fa-2x opacity-75"></i>
          </div>
          <div>
            <div class="h4 mb-0" id="utilizadoresActivos"><%= stats.activos %></div>
            <div class="small opacity-75">Utilizadores Activos</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <i class="fas fa-wifi fa-2x opacity-75"></i>
          </div>
          <div>
            <div class="h4 mb-0" id="utilizadoresOnline"><%= stats.online %></div>
            <div class="small opacity-75">Online Agora</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <i class="fas fa-user-shield fa-2x opacity-75"></i>
          </div>
          <div>
            <div class="h4 mb-0" id="perfisDistintos"><%= stats.perfis %></div>
            <div class="small opacity-75">Perfis Distintos</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filter-card">
    <form method="GET" action="/pessoas/utilizadores" id="filterForm">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="search" class="form-label">Pesquisar</label>
          <input type="text" class="form-control" id="search" name="search" 
                 value="<%= filters.search || '' %>" 
                 placeholder="Nome, email ou código...">
        </div>
        <div class="col-md-2">
          <label for="perfil" class="form-label">Perfil</label>
          <select class="form-select" id="perfil" name="perfil">
            <option value="">Todos os perfis</option>
            <option value="admin" <%= filters.perfil === 'admin' ? 'selected' : '' %>>Administrador</option>
            <option value="gerente" <%= filters.perfil === 'gerente' ? 'selected' : '' %>>Gerente</option>
            <option value="vendedor" <%= filters.perfil === 'vendedor' ? 'selected' : '' %>>Vendedor</option>
            <option value="caixa" <%= filters.perfil === 'caixa' ? 'selected' : '' %>>Operador de Caixa</option>
            <option value="operador" <%= filters.perfil === 'operador' ? 'selected' : '' %>>Operador</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status">
            <option value="">Todos os status</option>
            <option value="activo" <%= filters.status === 'activo' ? 'selected' : '' %>>Activo</option>
            <option value="inactivo" <%= filters.status === 'inactivo' ? 'selected' : '' %>>Inactivo</option>
            <option value="bloqueado" <%= filters.status === 'bloqueado' ? 'selected' : '' %>>Bloqueado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="loja" class="form-label">Loja</label>
          <select class="form-select" id="loja" name="loja">
            <option value="">Todas as lojas</option>
            <option value="1" <%= filters.loja === '1' ? 'selected' : '' %>>Loja Central</option>
            <option value="2" <%= filters.loja === '2' ? 'selected' : '' %>>Loja Norte</option>
            <option value="3" <%= filters.loja === '3' ? 'selected' : '' %>>Loja Sul</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">
              <i class="fas fa-search"></i> Filtrar
            </button>
            <a href="/pessoas/utilizadores" class="btn btn-outline-secondary">
              <i class="fas fa-times"></i> Limpar
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Lista de Utilizadores -->
  <div class="row">
    <% utilizadores.forEach(function(utilizador) { %>
    <div class="col-md-6 col-lg-4">
      <div class="user-card">
        <div class="d-flex align-items-start">
          <div class="user-avatar me-3">
            <%= utilizador.nome.charAt(0).toUpperCase() %>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1"><%= utilizador.nome %></h6>
                <small class="text-muted"><%= utilizador.email %></small>
              </div>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                        type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/pessoas/utilizadores/<%= utilizador.id %>"><i class="fas fa-eye"></i> Ver</a></li>
                  <li><a class="dropdown-item" href="/pessoas/utilizadores/<%= utilizador.id %>/edit"><i class="fas fa-edit"></i> Editar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="confirmarExclusao(<%= utilizador.id %>, '<%= utilizador.nome %>')"><i class="fas fa-trash"></i> Excluir</a></li>
                </ul>
              </div>
            </div>
            
            <div class="mb-2">
              <span class="perfil-badge perfil-<%= utilizador.perfil %>">
                <%= utilizador.perfil.charAt(0).toUpperCase() + utilizador.perfil.slice(1) %>
              </span>
              <span class="status-badge status-<%= utilizador.status %>">
                <%= utilizador.status.charAt(0).toUpperCase() + utilizador.status.slice(1) %>
              </span>
            </div>
            
            <div class="mb-2">
              <small class="text-muted">
                <i class="fas fa-store"></i> 
                <% utilizador.lojas.forEach(function(loja, index) { %>
                  <span class="loja-badge"><%= loja %></span>
                <% }); %>
              </small>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
              <small class="last-login">
                <span class="activity-indicator activity-<%= utilizador.atividade %>"></span>
                <%= utilizador.ultimo_acesso %>
              </small>
              <small class="text-muted">
                <i class="fas fa-calendar"></i> <%= utilizador.data_criacao %>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% }); %>
  </div>

  <!-- Paginação -->
  <% if (pagination.totalPages > 1) { %>
  <nav aria-label="Navegação de páginas">
    <ul class="pagination justify-content-center">
      <% if (pagination.currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&search=<%= filters.search || '' %>&perfil=<%= filters.perfil || '' %>&status=<%= filters.status || '' %>&loja=<%= filters.loja || '' %>">
            <i class="fas fa-chevron-left"></i> Anterior
          </a>
        </li>
      <% } %>
      
      <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
        <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>&search=<%= filters.search || '' %>&perfil=<%= filters.perfil || '' %>&status=<%= filters.status || '' %>&loja=<%= filters.loja || '' %>"><%= i %></a>
        </li>
      <% } %>
      
      <% if (pagination.currentPage < pagination.totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&search=<%= filters.search || '' %>&perfil=<%= filters.perfil || '' %>&status=<%= filters.status || '' %>&loja=<%= filters.loja || '' %>">
            Próxima <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      <% } %>
    </ul>
  </nav>
  <% } %>
</div>

<!-- Modal de Importação -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importar Utilizadores</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="upload-area" id="uploadArea">
          <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
          <h5>Arraste e solte o arquivo aqui</h5>
          <p class="text-muted">ou clique para selecionar um arquivo</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
          <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
            Selecionar Arquivo
          </button>
        </div>
        <div class="progress-container">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <small class="text-muted mt-2">Processando arquivo...</small>
        </div>
        <div class="mt-3">
          <small class="text-muted">
            <strong>Formatos aceitos:</strong> Excel (.xlsx, .xls) ou CSV (.csv)<br>
            <strong>Tamanho máximo:</strong> 10MB
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="uploadBtn" disabled>Importar</button>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script>
// Filtro automático
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search');
  const filterSelects = document.querySelectorAll('#perfil, #status, #loja');
  
  // Auto-submit no search após 500ms de inatividade
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
      document.getElementById('filterForm').submit();
    }, 500);
  });
  
  // Auto-submit nos selects
  filterSelects.forEach(function(select) {
    select.addEventListener('change', function() {
      document.getElementById('filterForm').submit();
    });
  });
});

// Confirmação de exclusão
function confirmarExclusao(id, nome) {
  if (confirm(`Tem certeza que deseja excluir o utilizador "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
    // Simular exclusão
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/pessoas/utilizadores/${id}`;
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'DELETE';
    
    form.appendChild(methodInput);
    document.body.appendChild(form);
    form.submit();
  }
}

// Upload de arquivo
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const progressContainer = document.querySelector('.progress-container');
  const progressBar = document.querySelector('.progress-bar');
  
  // Drag and drop
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });
  
  // File input change
  fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });
  
  function handleFile(file) {
    const allowedTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                         'application/vnd.ms-excel', 'text/csv'];
    
    if (!allowedTypes.includes(file.type)) {
      alert('Formato de arquivo não suportado. Use Excel ou CSV.');
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
      alert('Arquivo muito grande. Tamanho máximo: 10MB.');
      return;
    }
    
    uploadBtn.disabled = false;
    uploadArea.innerHTML = `
      <i class="fas fa-file-excel fa-2x text-success mb-2"></i>
      <h6>${file.name}</h6>
      <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
    `;
  }
  
  // Upload button
  uploadBtn.addEventListener('click', function() {
    progressContainer.style.display = 'block';
    uploadBtn.disabled = true;
    
    // Simular upload
    let progress = 0;
    const interval = setInterval(function() {
      progress += Math.random() * 30;
      if (progress >= 100) {
        progress = 100;
        clearInterval(interval);
        setTimeout(function() {
          alert('Arquivo importado com sucesso!');
          location.reload();
        }, 500);
      }
      progressBar.style.width = progress + '%';
    }, 200);
  });
});

// Exportar para PDF
function exportarPDF() {
  // Simular exportação
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
  btn.disabled = true;
  
  setTimeout(function() {
    window.open('/api/pessoas/utilizadores/export/pdf', '_blank');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 2000);
}

// Exportar para Excel
function exportarExcel() {
  // Simular exportação
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
  btn.disabled = true;
  
  setTimeout(function() {
    window.open('/api/pessoas/utilizadores/export/excel', '_blank');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 2000);
}

// Exportar para CSV
function exportarCSV() {
  // Simular exportação
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
  btn.disabled = true;
  
  setTimeout(function() {
    window.open('/api/pessoas/utilizadores/export/csv', '_blank');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 2000);
}
</script>

